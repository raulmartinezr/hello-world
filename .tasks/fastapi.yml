version: "3"

vars:
  PYTHONPATH: src
  ENTRY: "{{.ENTRY | default `src.hello_world.app.__main__:app` }}"   # entry file or import string (e.g. app.main:app)
  HOST: "{{.HOST  | default `127.0.0.1` }}"
  PORT: "{{.PORT  | default `8000` }}"
  WORKERS: "{{.WORKERS | default `2` }}"
  THREADS_PER_WORKER: "{{.THREADS_PER_WORKER | default `2` }}"
  FASTAPI_FLAGS: "{{.FLAGS | default `` }}"      # extra CLI flags, passed as-is


tasks:

  dev:
    desc: Run FastAPI in development mode with auto-reload
    #deps: [deps]
    cmds:
      - pwd
      - granian --interface asgi --reload --host {{.HOST}} --port {{.PORT}} --workers {{.WORKERS}} --runtime-threads {{.THREADS_PER_WORKER}}  {{.ENTRY}}

  run:
    desc: Run FastAPI in production mode (no reload, multiple workers)
    #deps: [deps]
    cmds:
      - granian --interface asgi --host 0.0.0.0 --port 5015 --workers {{.WORKERS}} --runtime-threads {{.THREADS_PER_WORKER}}  {{.ENTRY}}

  openapi:
    desc: Fetch the OpenAPI JSON (requires server running)
    cmds:
      - curl -s "http://{{.HOST}}:{{.PORT}}/openapi.json" | jq .

  docs-url:
    desc: Print Swagger UI URL
    cmds:
      - echo "http://{{.HOST}}:{{.PORT}}/docs"
